# 单元测试范围
## 遇到的坑，以及好的practice建议
接下来讲讲我们遇到的一些坑，以及一些好的practice建议。

1. Native libary
无论是纯JUnit还是Robolectric，都不支持load native library，会报UnsatisfiedLinkError的错。所以如果你的被测代码里面用到了native lib，那么可能需要给System.loadLibrary加上try catch。
如果是被测代码用到的第三方lib，而里面用到了native lib的话，一般有两种解决办法，一种是将用到native lib的第三方类外面自己在包一层，然后在测试的情况下mock掉。第二种是用Robolectric，给那个类创建一个shadow class。
第一种方法的好处是可以在测试的时候随时改变这个类的返回值或行为，缺点是需要另外创建一个wrapper类，会有点繁琐。第二种方式不能随时改变这个类的行为，但是写起来非常简单。所以，看自己的需要，选择相应的方法。
这两种方法，也是解决static method, final class/method不能mock的主要方式。

2. 公共的单元测试library
如果你们公司也是组件化开发的话，抽出一个公共的单元测试类库来做单元测试，里面可以放一些公共的helper、utils、rules等等，这个可以极大的提高写单元测试的速度。

3. 把安卓里面的“纯java”代码copy一份到自己的项目里面
安卓里面有些类其实跟安卓没太大关系的，比如说TextUtils、Color等等，这些类完全可以把代码copy出来，放到自己的项目里面，然后其他地方就用这个类，这样也能部分摆脱android的依赖，使用JUnit而不是Robolectric，提高运行test的速度。

4. 不要追求完美
刚开始的时候，不用追求测试代码的质量，也不用追求完美，如果有些地方不好写测试，可以先放放，以后再来补，有部分测试总比没有测试好。

Martin Fowler说过
>
Imperfect tests, run frequently, are much better than perfect tests that are never written at all.
 
    然而等你熟悉写测试的方法以后，强烈建议先写测试！因为如果你先写了正式代码，那你对这写代码是如何work的已经有一个印象了，因此你往往会写出能顺利通过的测试，而忽略一些会让测试不通过的情况。如果先写测试，则能考虑得更全面。
 
## QA环节
Q：如何测试界面交互？如点击拖动等。
 
A：Robolectric提供了非常丰富的测试交互的方式，比如findViewById(id).performClick()。基本上，使用Robolectric，你可以像正常写安卓代码那样写测试代码。甚至正常情况下没有的方法，Robolectric也提供了。
 
Q：我也是后来才接触代码测试的，然后开始喜欢上写代码测试，但当尝试为以前的代码写代码测试的时候，发现以前的结构很难写代码测试，请问你们也有遇到这种情况么？如何解决。
 
A：这的确是比较头疼的问题，建议可以看看《Working Effective With Legacy Code》一般来说就是挑选一个比较好下手的地方，做好隔离写好测试，在重构。那本书里面提出了很多简单除暴的方式，比如把一个方法或变量从private改成public等等。
 
Q：自绘控件一般怎么去做自动化测试？
 
A: 自定义控件一般只测他的功能性的部分，样式、动画这样的一般不测。
 
测试方式基本就是把这个控件new 出来，然后调用它的public 方法，验证它的text是不是正确等等。或者是相应的事件有没有触发，这个借助Robolectric可以做到。
 
Q：业务测试数据，是自己本地写的逻辑，还是结合服务器的真实逻辑？
 
A：对于单元测试来说，一般是自己mock服务器的返回结果，因为服务器返回结果是不是正确的，其实不是我们应该测的情况，而是服务器应该测的情况，我们要测的，是服务器返回正确的结果我们就显示正确的结果，服务器返回错误的结果，我们就显示错误的返回信息。
 
 
Q：对于依赖环境的测试，比如有无网络，不同的网络测试类型，不同的网络类型，网络超时等，这种怎么去做单元测试比较好？在比如测试试写文件的方法，怎么去构造剩余空间不足、空间足够的环境？
 
A：这些情况需要借助系统的api(比如NetworkManager),去判断情况，这种情况可以把这些系统的api mock掉，指定让他返回你想要指定的结果。